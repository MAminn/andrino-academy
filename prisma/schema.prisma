// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  password      String?
  role          String    @default("student") // student, instructor, coordinator, manager, ceo
  emailVerified DateTime?
  image         String?
  
  // Student-specific fields
  age           Int?
  parentEmail   String?
  parentPhone   String?
  parentName    String?
  priorExperience String? // "none", "basic", "intermediate", "advanced"
  gradeLevel    String? // Calculated dynamically: "beginner", "elementary", "intermediate", "advanced"
  gradeId       String? // Assigned grade for school structure
  
  // Profile fields
  phone         String?
  address       String?
  emergencyContact String?
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  accounts              Account[]
  sessions              Session[]
  instructedCourses     Course[]                  @relation("CourseInstructor")
  enrollments           Enrollment[]
  assignments           Assignment[]              @relation("AssignmentInstructor")
  assignmentSubmissions AssignmentSubmission[]
  exams                 Exam[]                    @relation("ExamInstructor")
  attendances           Attendance[]
  certificates          Certificate[]
  payments              Payment[]
  invoices              Invoice[]
  sessionProgress       SessionProgress[]
  learningActivities    LearningActivity[]
  learningStreak        LearningStreak?
  progressMilestones    ProgressMilestone[]

  // Academic Structure Relations
  assignedGrade         Grade?                    @relation("StudentGrade", fields: [gradeId], references: [id], onDelete: SetNull)
  instructedTracks      Track[]                   @relation("TrackInstructor")
  coordinatedTracks     Track[]                   @relation("TrackCoordinator")
  instructedSessions    LiveSession[]             @relation("SessionInstructor")
  sessionAttendances    SessionAttendance[]       @relation("StudentSessionAttendance")

  // New Relations - Availability & Booking System
  instructorAvailability InstructorAvailability[] @relation("InstructorAvailability")
  studentBookings        SessionBooking[]         @relation("StudentBookings")
  assignmentSubmissionsStudent AssignmentSubmissionNew[] @relation("StudentSubmissions")
  assignmentGrading      AssignmentSubmissionNew[] @relation("InstructorGrading")

  @@map("User")
}

// NextAuth.js required models
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("Account")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("Session")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("VerificationToken")
}

// LMS Models
model Course {
  id                    String        @id @default(cuid())
  title                 String
  description           String?
  thumbnail             String?
  price                 Decimal?
  category              String?
  level                 String        @default("beginner")
  duration              Int?
  isPublished           Boolean       @default(false)
  programmingLanguages  String?       // JSON string
  skillLevel            String        @default("BEGINNER")
  ageGroup              String?
  tools                 String?       // JSON string
  githubRepo            String?
  meetingLink           String?
  schedulePattern       String?
  totalSessions         Int?
  prerequisites         String?       // JSON string
  currency              String?
  subscriptionEligible  Boolean       @default(false)
  isActive              Boolean       @default(true)
  instructorId          String
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt

  instructor            User                    @relation("CourseInstructor", fields: [instructorId], references: [id], onDelete: Cascade)
  sessions              CourseSession[]
  enrollments           Enrollment[]
  assignments           Assignment[]
  exams                 Exam[]
  certificates          Certificate[]
  learningActivities    LearningActivity[]
  progressMilestones    ProgressMilestone[]

  @@index([isActive])
  @@index([instructorId])
  @@map("Course")
}

model CourseSession {
  id              String   @id @default(cuid())
  title           String
  description     String?
  startsAt        DateTime
  endsAt          DateTime
  timezone        String?
  meetingLink     String
  recordingLink   String?
  materials       String?  // JSON string
  topics          String?  // JSON string
  videoUrl        String?
  duration        Int?
  order           Int?
  isPublished     Boolean  @default(false)
  courseId        String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  course             Course              @relation(fields: [courseId], references: [id], onDelete: Cascade)
  attendances        Attendance[]
  sessionProgress    SessionProgress[]
  learningActivities LearningActivity[]

  @@index([courseId, startsAt])
  @@map("CourseSession")
}

model Enrollment {
  id              String    @id @default(cuid())
  studentId       String
  courseId        String
  enrolledAt      DateTime  @default(now())
  completedAt     DateTime?
  progress        Float     @default(0)
  status          String    @default("active")
  lastAccessedAt  DateTime?
  totalTimeSpent  Int       @default(0)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  student            User                  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  course             Course                @relation(fields: [courseId], references: [id], onDelete: Cascade)
  attendances        Attendance[]
  sessionProgress    SessionProgress[]
  progressMilestones ProgressMilestone[]

  @@unique([studentId, courseId])
  @@map("Enrollment")
}

model Assignment {
  id           String   @id @default(cuid())
  title        String
  description  String
  dueDate      DateTime
  courseId     String
  instructorId String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  course               Course                 @relation(fields: [courseId], references: [id], onDelete: Cascade)
  instructor           User                   @relation("AssignmentInstructor", fields: [instructorId], references: [id], onDelete: Cascade)
  submissions          AssignmentSubmission[]
  learningActivities   LearningActivity[]

  @@map("Assignment")
}

model AssignmentSubmission {
  id           String   @id @default(cuid())
  submission   String
  submittedAt  DateTime @default(now())
  grade        String?
  assignmentId String
  studentId    String

  assignment Assignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  student    User       @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([assignmentId, studentId])
  @@map("AssignmentSubmission")
}

model Exam {
  id           String   @id @default(cuid())
  title        String
  description  String?
  examLink     String
  date         DateTime
  courseId     String
  instructorId String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  course     Course @relation(fields: [courseId], references: [id], onDelete: Cascade)
  instructor User   @relation("ExamInstructor", fields: [instructorId], references: [id], onDelete: Cascade)

  @@map("Exam")
}

model Attendance {
  id           String   @id @default(cuid())
  status       String
  markedAt     DateTime @default(now())
  sessionId    String
  studentId    String
  enrollmentId String?

  session    CourseSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  student    User          @relation(fields: [studentId], references: [id], onDelete: Cascade)
  enrollment Enrollment?   @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)

  @@unique([sessionId, studentId])
  @@map("Attendance")
}

model Certificate {
  id        String   @id @default(cuid())
  issuedAt  DateTime @default(now())
  pdfUrl    String?
  studentId String
  courseId  String

  student User   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  course  Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([studentId, courseId])
  @@map("Certificate")
}

model Payment {
  id            String   @id @default(cuid())
  amount        Float
  currency      String   @default("USD")
  status        String   @default("pending")
  method        String?
  transactionId String?
  paidAt        DateTime?
  studentId     String
  invoiceId     String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  student User     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  invoice Invoice? @relation(fields: [invoiceId], references: [id], onDelete: SetNull)

  @@map("Payment")
}

model Invoice {
  id            String   @id @default(cuid())
  invoiceNumber String   @unique
  amount        Float
  currency      String   @default("USD")
  status        String   @default("draft")
  dueDate       DateTime?
  issuedAt      DateTime @default(now())
  paidAt        DateTime?
  items         String?  // JSON string
  studentId     String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  student  User      @relation(fields: [studentId], references: [id], onDelete: Cascade)
  payments Payment[]

  @@map("Invoice")
}

model SessionProgress {
  id               String    @id @default(cuid())
  sessionId        String
  studentId        String
  enrollmentId     String
  startedAt        DateTime?
  completedAt      DateTime?
  timeSpent        Int       @default(0)
  status           String    @default("not_started")
  watchPercentage  Float     @default(0)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  session    CourseSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  student    User          @relation(fields: [studentId], references: [id], onDelete: Cascade)
  enrollment Enrollment    @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)

  @@unique([sessionId, studentId])
  @@index([enrollmentId])
  @@index([status])
  @@map("SessionProgress")
}

model LearningActivity {
  id           String   @id @default(cuid())
  studentId    String
  courseId     String?
  sessionId    String?
  assignmentId String?
  activityType String
  description  String
  duration     Int      @default(0)
  points       Int      @default(0)
  createdAt    DateTime @default(now())

  student    User           @relation(fields: [studentId], references: [id], onDelete: Cascade)
  course     Course?        @relation(fields: [courseId], references: [id], onDelete: Cascade)
  session    CourseSession? @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  assignment Assignment?    @relation(fields: [assignmentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([courseId])
  @@index([activityType])
  @@index([createdAt])
  @@map("LearningActivity")
}

model LearningStreak {
  id               String    @id @default(cuid())
  studentId        String    @unique
  currentStreak    Int       @default(0)
  longestStreak    Int       @default(0)
  lastActivityDate DateTime?
  streakStartDate  DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  student User @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@map("LearningStreak")
}

model ProgressMilestone {
  id                 String   @id @default(cuid())
  studentId          String
  courseId           String
  enrollmentId       String
  milestoneType      String
  title              String
  description        String?
  progressPercentage Float
  achievedAt         DateTime @default(now())
  points             Int      @default(0)

  student    User       @relation(fields: [studentId], references: [id], onDelete: Cascade)
  course     Course     @relation(fields: [courseId], references: [id], onDelete: Cascade)
  enrollment Enrollment @relation(fields: [enrollmentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([courseId])
  @@index([milestoneType])
  @@map("ProgressMilestone")
}

// Academic Structure Models for School-like LMS
model Grade {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  order       Int?     // For ordering grades (1st, 2nd, etc.)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  students    User[]   @relation("StudentGrade")
  tracks      Track[]

  @@index([isActive])
  @@index([order])
  @@map("Grade")
}

model Track {
  id            String   @id @default(cuid())
  name          String
  description   String?
  gradeId       String
  instructorId  String
  coordinatorId String
  isActive      Boolean  @default(true)
  order         Int?     // For ordering tracks within a grade
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  grade        Grade         @relation(fields: [gradeId], references: [id], onDelete: Cascade)
  instructor   User          @relation("TrackInstructor", fields: [instructorId], references: [id], onDelete: Restrict)
  coordinator  User          @relation("TrackCoordinator", fields: [coordinatorId], references: [id], onDelete: Restrict)
  liveSessions LiveSession[]
  modules      Module[]      // Course content modules
  
  // New Relations - Availability & Booking
  instructorAvailability InstructorAvailability[]
  sessionBookings        SessionBooking[]

  @@index([gradeId])
  @@index([instructorId])
  @@index([coordinatorId])
  @@index([isActive])
  @@map("Track")
}

model LiveSession {
  id           String   @id @default(cuid())
  title        String
  description  String?
  trackId      String
  instructorId String
  date         DateTime
  startTime    String   // Format: "HH:mm" (e.g., "14:30")
  endTime      String   // Format: "HH:mm" (e.g., "16:00")
  externalLink String?  // External meeting URL (Zoom, Google Meet, Teams, etc.)
  status       SessionStatus @default(DRAFT) // DRAFT, SCHEDULED, READY, ACTIVE, COMPLETED, CANCELLED
  materials    String?  // JSON string for session materials/links
  notes        String?  // Instructor notes
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  track          Track              @relation(fields: [trackId], references: [id], onDelete: Cascade)
  instructor     User               @relation("SessionInstructor", fields: [instructorId], references: [id], onDelete: Restrict)
  attendances    SessionAttendance[]
  modules        Module[]           // Session-specific materials
  
  // New Relation - Link to bookings
  bookings       SessionBooking[]

  @@index([trackId])
  @@index([instructorId])
  @@index([date])
  @@index([status])
  @@map("LiveSession")
}

model SessionAttendance {
  id            String   @id @default(cuid())
  sessionId     String
  studentId     String
  status        String   @default("absent") // present, absent, late, excused
  markedAt      DateTime @default(now())
  markedBy      String?  // coordinator or instructor who marked attendance
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  session LiveSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  student User        @relation("StudentSessionAttendance", fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([sessionId, studentId])
  @@index([sessionId])
  @@index([studentId])
  @@index([status])
  @@map("SessionAttendance")
}

// Course Content Management Models - RESTRUCTURED
model Module {
  id              String         @id @default(cuid())
  title           String
  description     String?
  targetAudience  String         @default("student") // "instructor" or "student"
  category        ModuleCategory @default(UNCATEGORIZED) // Categorize materials
  order           Int            @default(0) // Display order within track
  isPublished     Boolean        @default(false) // Manager-controlled visibility
  trackId         String         // Track this module belongs to
  sessionId       String?        // Optional: Specific session this material is for
  uploadedBy      String         // Manager who uploaded
  weekNumber      Int?           // Week number for scheduled content (1, 2, 3, ...)
  startDate       DateTime?      // Manager-specified start date for this week's content
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  // Relations
  track           Track          @relation(fields: [trackId], references: [id], onDelete: Cascade)
  session         LiveSession?   @relation(fields: [sessionId], references: [id], onDelete: SetNull)
  
  // New Relations - Multi-content support
  contentItems    ContentItem[]
  tasks           Task[]
  assignments     AssignmentNew[]

  @@index([trackId])
  @@index([sessionId])
  @@index([category])
  @@index([isPublished])
  @@index([order])
  @@index([targetAudience])
  @@index([weekNumber])
  @@index([startDate])
  @@map("Module")
}

// Multi-content support: One module can have multiple files
model ContentItem {
  id             String      @id @default(cuid())
  moduleId       String
  type           ModuleType  // VIDEO, PDF, DOCUMENT, IMAGE
  fileUrl        String      // Path to uploaded file
  fileName       String      // Original file name
  fileSize       Int         // File size in bytes
  mimeType       String      // MIME type for proper handling
  duration       Int?        // Video duration in seconds (auto-extracted)
  order          Int         @default(0) // Display order (0=first, 1=second, etc.)
  targetAudience String?     // "instructor" or "student" - who this content is for
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  // Relations
  module Module @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  @@index([moduleId])
  @@index([order])
  @@map("ContentItem")
}

// Tasks - Text-based tasks for students
model Task {
  id          String   @id @default(cuid())
  moduleId    String
  title       String
  description String
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  module Module @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  @@index([moduleId])
  @@index([order])
  @@map("Task")
}

// Assignments - File-based assignments for students
model AssignmentNew {
  id          String   @id @default(cuid())
  moduleId    String
  title       String
  description String
  fileUrl     String?  // Optional assignment PDF/doc uploaded by manager
  fileName    String?
  fileSize    Int?
  mimeType    String?
  dueDate     DateTime?
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  module      Module                      @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  submissions AssignmentSubmissionNew[]

  @@index([moduleId])
  @@index([order])
  @@map("AssignmentNew")
}

// Assignment Submissions - Students submit solutions
model AssignmentSubmissionNew {
  id            String    @id @default(cuid())
  assignmentId  String
  studentId     String
  fileUrl       String    // Student's uploaded solution
  fileName      String
  fileSize      Int
  mimeType      String
  submittedAt   DateTime  @default(now())
  grade         Float?    // Numeric grade
  feedback      String?   // Instructor feedback
  gradedAt      DateTime?
  gradedBy      String?   // Instructor ID
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  assignment AssignmentNew @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  student    User          @relation("StudentSubmissions", fields: [studentId], references: [id], onDelete: Cascade)
  grader     User?         @relation("InstructorGrading", fields: [gradedBy], references: [id], onDelete: SetNull)

  @@unique([assignmentId, studentId])
  @@index([studentId])
  @@index([assignmentId])
  @@map("AssignmentSubmissionNew")
}

// Instructor Availability - Weekly time slots
model InstructorAvailability {
  id            String   @id @default(cuid())
  instructorId  String
  trackId       String
  weekStartDate DateTime // Monday of the week this applies to
  dayOfWeek     Int      // 0=Sunday, 1=Monday, 2=Tuesday, 3=Wednesday, 4=Thursday, 5=Friday, 6=Saturday
  startHour     Int      // 13-22 (1pm-10pm in 24h format)
  endHour       Int      // 13-22 (1pm-10pm in 24h format)
  isBooked      Boolean  @default(false)
  isConfirmed   Boolean  @default(false) // Once confirmed, can't edit
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  instructor User             @relation("InstructorAvailability", fields: [instructorId], references: [id], onDelete: Cascade)
  track      Track            @relation(fields: [trackId], references: [id], onDelete: Cascade)
  bookings   SessionBooking[]

  @@unique([instructorId, trackId, weekStartDate, dayOfWeek, startHour])
  @@index([instructorId])
  @@index([trackId])
  @@index([weekStartDate])
  @@map("InstructorAvailability")
}

// Session Booking - Students book instructor availability slots
model SessionBooking {
  id              String   @id @default(cuid())
  availabilityId  String
  studentId       String
  trackId         String
  sessionId       String?  // Linked once instructor creates LiveSession
  status          String   @default("booked") // booked, confirmed, completed, cancelled
  studentNotes    String?  // Student notes about instructor
  instructorNotes String?  // Instructor notes about student
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  availability InstructorAvailability @relation(fields: [availabilityId], references: [id], onDelete: Cascade)
  student      User                   @relation("StudentBookings", fields: [studentId], references: [id], onDelete: Cascade)
  track        Track                  @relation(fields: [trackId], references: [id], onDelete: Cascade)
  session      LiveSession?           @relation(fields: [sessionId], references: [id], onDelete: SetNull)

  @@unique([availabilityId, studentId])
  @@index([studentId])
  @@index([trackId])
  @@index([availabilityId])
  @@map("SessionBooking")
}

// Schedule Settings - Manager controls when availability resets
model ScheduleSettings {
  id                    String   @id @default(cuid())
  weekResetDay          Int      @default(6) // 6=Saturday, 0=Sunday, etc.
  weekResetHour         Int      @default(0) // 0=midnight (24h format)
  availabilityOpenHours Int      @default(24) // How long instructors have to set availability
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@map("ScheduleSettings")
}

// Session Status Enum for External Coordination Platform
enum SessionStatus {
  DRAFT      // Session created without external link
  SCHEDULED  // Session scheduled with date/time but no external link
  READY      // Session has external link and is ready to start
  ACTIVE     // Session is currently in progress (external link active)
  PAUSED     // Session temporarily paused
  COMPLETED  // Session finished successfully
  CANCELLED  // Session was cancelled
}

// Module Type Enum
enum ModuleType {
  VIDEO
  PDF
  DOCUMENT
  IMAGE
}

// Module Category Enum for organized content
enum ModuleCategory {
  LECTURE         // Main lecture videos
  TUTORIAL        // Step-by-step tutorials
  EXERCISE        // Practice exercises
  REFERENCE       // Reference materials
  SLIDES          // Presentation slides
  HANDOUT         // Handouts and notes
  ASSIGNMENT      // Assignment materials
  SOLUTION        // Solution files
  SUPPLEMENTARY   // Supplementary materials
  PROJECT         // Project-based learning
  UNCATEGORIZED   // Default category
}

// Subscription Packages Model
model Package {
  id                String   @id @default(cuid())
  name              String   // Package name (e.g., "مستوى احترافي")
  price             Float    // Original price
  discountedPrice   Float?   // Discounted price (null or 0 = no discount)
  minAge            Int      // Minimum age criteria
  maxAge            Int      // Maximum age criteria
  description       String   // Rich description/curriculum details
  perks             String   // JSON array of perk strings with checkmarks
  durationMonths    Int      // Duration in months (e.g., 12)
  sessionsPerLevel  Int      // Number of sessions per level (e.g., 48)
  pricePerSession   Float    // Calculated: price / sessionsPerLevel
  badge             String?  // Optional badge text (e.g., "Best Value", "Most Popular")
  order             Int      @default(0) // Display order (lower = first)
  isActive          Boolean  @default(true) // Show/hide without deleting
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([isActive])
  @@index([order])
  @@map("Package")
}
